name: Cleanup Preview Environment

on:
  pull_request:
    types: [closed]
    branches: [main]
    paths: ['static-web-app/**', '!static-web-app/README.md', '.github/workflows/deploy-*.yml']

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  STATIC_WEB_APP_NAME: "swa-kennethheine-com-dkwcwwqm6kfxy"
  RESOURCE_GROUP_NAME: "rg-kennethheine-prod"

jobs:
  cleanup-preview:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Azure Authentication
        run: |
          echo "ðŸ” Verifying Azure CLI setup for cleanup..."
          az version
          az account show
          echo "âœ… Authentication verified"

      - name: Get Static Web App Deployment Token
        id: swa-token
        run: |
          echo "ðŸ”‘ Retrieving Static Web App deployment token for cleanup..."
          
          deployment_token=$(az staticwebapp secrets list \
            --name "${{ env.STATIC_WEB_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --query "properties.apiKey" \
            --output tsv)
          
          if [ -z "$deployment_token" ]; then
            echo "âŒ Failed to retrieve deployment token"
            exit 1
          fi
          echo "deployment-token=$deployment_token" >> $GITHUB_OUTPUT
          echo "âœ… Deployment token retrieved for cleanup"

      - name: Cleanup Preview Environment
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.deployment-token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "close"
          app_location: "/"
          skip_app_build: true

      - name: Verify Cleanup
        run: |
          echo "ðŸ” Verifying preview environment cleanup..."
          echo "âœ… Preview environment cleanup initiated successfully"
          echo "ðŸ—‘ï¸ Preview URL will be deactivated within a few minutes"

      - name: Comment PR with Cleanup Confirmation
        uses: actions/github-script@v7
        with:
          script: |
            const prStatus = context.payload.pull_request.merged ? 'merged' : 'closed';
            const statusEmoji = context.payload.pull_request.merged ? 'ðŸŽ‰' : 'ðŸ”’';
            
            const comment = `## ðŸ§¹ Preview Environment Cleaned Up
            
            The preview environment for this pull request has been successfully removed.
            
            **Cleanup Details:**
            - ðŸ—‘ï¸ Preview environment: \`Deactivated and removed\`
            - ðŸ“… Cleaned up: \`${new Date().toISOString()}\`
            - ðŸ”— Status: \`${prStatus}\`
            - ðŸ”„ Commit: \`${context.sha.substring(0, 7)}\`
            
            **Environment Status:**
            - ðŸŒ Preview URL: \`Deactivated\`
            - ðŸ’¾ Resources: \`Cleaned up automatically\`
            - ðŸ”’ Security: \`No dangling resources or access\`
            
            ${statusEmoji} Thank you for your contribution!`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Create Cleanup Summary
        if: always()
        run: |
          pr_status="${{ github.event.pull_request.merged && 'merged' || 'closed' }}"
          
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## ðŸ§¹ Preview Environment Cleanup
          
          **Cleanup Status:** ${{ job.status == 'success' && 'âœ… **SUCCESS** - Preview environment removed successfully!' || 'âŒ **FAILED** - Cleanup encountered errors. Check logs above.' }}
          
          **Details:**
          - ðŸ”— Pull Request: \`#${{ github.event.number }}\`
          - ðŸ“ Static Web App: \`${{ env.STATIC_WEB_APP_NAME }}\`
          - ðŸ—‘ï¸ Action: \`Preview environment cleanup\`
          - ðŸ“… Cleanup Time: \`$(date -u '+%Y-%m-%d %H:%M:%S UTC')\`
          - ðŸ”„ Trigger: \`PR $pr_status\`
          - ðŸ”„ Commit: \`${{ github.sha }}\`
          
          **Environment Status:**
          - ðŸŒ Preview URL: \`Deactivated and removed\`
          - ðŸ’¾ Resources: \`Cleaned up automatically\`
          - ðŸ”’ Security: \`No dangling resources or access\`
            EOF
