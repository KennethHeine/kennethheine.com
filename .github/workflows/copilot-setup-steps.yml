name: "Copilot Setup Steps"

# Automatically run the setup steps when they are changed to allow for easy validation, and
# allow manual testing through the repository's "Actions" tab
on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  # The job MUST be called `copilot-setup-steps` or it will not be picked up by Copilot.
  copilot-setup-steps:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Set the permissions to the lowest permissions possible needed for your steps.
    # Copilot will be given its own token for its operations.
    permissions:
      contents: read

    steps:
      # ğŸ—ï¸ Environment Setup
      - name: "ğŸ” Checkout repository"
        uses: actions/checkout@v4

      # ğŸ“¦ Node.js Setup for Frontend Development
      - name: "âš¡ Setup Node.js 22"
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: "static-web-app/package-lock.json"      # ğŸ—ï¸ Install Frontend Dependencies
      - name: "ğŸ“¦ Install JavaScript dependencies"
        working-directory: ./static-web-app
        run: |
          npm ci --prefer-offline --no-audit
          echo "âœ… Node.js dependencies installed successfully"

      # ğŸ§ª Validate Project Setup
      - name: "ğŸ§ª Validate project configuration"
        working-directory: ./static-web-app
        run: |
          echo "ğŸ” Validating TypeScript configuration..."
          npx tsc --noEmit
          
          echo "ğŸ” Validating ESLint configuration..."
          npm run lint
          
          echo "ğŸ” Validating Prettier configuration..."
          npm run format:check
          
          echo "âœ… All validation checks passed"

      # ğŸ§ª Run Test Suite
      - name: "ğŸ§ª Run test suite"
        working-directory: ./static-web-app
        run: |
          echo "ğŸ§ª Running Jest test suite..."
          npm test -- --coverage --watchAll=false
          echo "âœ… All tests passed successfully"

      # ğŸ“Š Cache Test Results and Coverage
      - name: "ğŸ“Š Cache test results"
        uses: actions/cache@v4
        with:
          path: |
            static-web-app/coverage
            static-web-app/.next
          key: test-cache-${{ runner.os }}-${{ hashFiles('static-web-app/package-lock.json') }}
          restore-keys: |
            test-cache-${{ runner.os }}-

      # ğŸ”§ Install Additional Development Tools
      - name: "ğŸ”§ Setup additional development tools"
        run: |
          echo "ğŸ”§ Installing additional tools..."
          
          # Install global npm packages commonly used in development
          npm install -g @types/node typescript
          
          # Verify installations
          echo "âœ… Node.js version: $(node --version)"
          echo "âœ… npm version: $(npm --version)"
          echo "âœ… TypeScript version: $(npx tsc --version)"

      # ğŸ“‹ Environment Summary
      - name: "ğŸ“‹ Environment summary"
        run: |
          echo "ğŸ¯ Copilot Environment Ready!"
          echo "================================"
          echo "ğŸ“‚ Project: kennethheine.com"
          echo "ğŸ—ï¸ Type: Next.js Static Web Application"
          echo "âš¡ Frontend: Next.js 14 + TypeScript + Tailwind CSS"
          echo "ğŸ§ª Testing: Jest + React Testing Library"
          echo "ğŸ¨ Linting: ESLint + Prettier"
          echo "ğŸ“¦ Package Manager: npm"
          echo "ğŸ”§ TypeScript: Available for type checking"
          echo "ğŸ“ MDX: Available for content processing"
          echo "================================"
          echo "ğŸš€ Environment is ready for Copilot coding agent!"
          echo "ğŸ’¡ Focus: JavaScript/TypeScript frontend development"
