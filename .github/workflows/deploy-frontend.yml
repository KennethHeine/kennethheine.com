name: Deploy Frontend

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['static-web-app/**', '!static-web-app/README.md']
  pull_request:
    branches: [main]
    paths: ['static-web-app/**', '!static-web-app/README.md']

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  STATIC_WEB_APP_NAME: "swa-kennethheine-com-dkwcwwqm6kfxy"
  RESOURCE_GROUP_NAME: "rg-kennethheine-prod"

jobs:
  validate:
    name: Validate Frontend Code
    runs-on: ubuntu-latest
    outputs:
      app-location: ${{ steps.config.outputs.app-location }}
      output-location: ${{ steps.config.outputs.output-location }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'static-web-app/package.json'

      - name: Validate Frontend Structure
        run: |
          echo "üîç Validating frontend project structure..."
          
          # Check required files
          required_files=(            "static-web-app/package.json"
            "static-web-app/next.config.mjs"
            "static-web-app/staticwebapp.config.json"
            "static-web-app/app/layout.tsx"
            "static-web-app/app/page.tsx"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Required file missing: $file"
              exit 1
            else
              echo "‚úÖ Found: $file"
            fi
          done
          
          echo "üìÅ Frontend structure validation completed successfully!"

      - name: Install Dependencies
        working-directory: static-web-app
        run: |
          echo "üì¶ Installing frontend dependencies..."
          npm ci
          echo "‚úÖ Dependencies installed successfully!"

      - name: Lint and Validate Code
        working-directory: static-web-app
        run: |
          echo "üîç Running code validation..."
          
          # Validate HTML structure
          echo "üìÑ Validating HTML files..."
          find src -name "*.html" -type f | while read file; do
            echo "  Checking: $file"
            # Basic HTML validation - check for required tags
            if ! grep -q "<html" "$file"; then
              echo "‚ùå Missing <html> tag in $file"
              exit 1
            fi
            if ! grep -q "<head" "$file"; then
              echo "‚ùå Missing <head> tag in $file"
              exit 1
            fi
            if ! grep -q "<body" "$file"; then
              echo "‚ùå Missing <body> tag in $file"
              exit 1
            fi
          done
          
          # Check for common issues
          echo "üîç Checking for common issues..."
          if grep -r "localhost" src/ --exclude-dir=node_modules; then
            echo "‚ö†Ô∏è Warning: Found localhost references in code"
          fi
          
          echo "‚úÖ Code validation completed!"

      - name: Extract Configuration
        id: config
        run: |
          echo "üìã Extracting deployment configuration..."
          
          # Get app location from parameters file
          app_location=$(grep "appLocation" infra/parameters/production.bicepparam | cut -d"'" -f2)
          output_location=$(grep "outputLocation" infra/parameters/production.bicepparam | cut -d"'" -f2)
          
          echo "app-location=$app_location" >> $GITHUB_OUTPUT
          echo "output-location=$output_location" >> $GITHUB_OUTPUT
          
          echo "üìç App Location: $app_location"
          echo "üì§ Output Location: $output_location"

  deploy:
    name: Deploy to Azure Static Web Apps
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Azure Authentication
        run: |
          echo "üîç Verifying Azure CLI setup..."
          az version
          az account show
          echo "‚úÖ Authentication verified"

      - name: Get Static Web App Deployment Token
        id: swa-token
        run: |
          echo "üîë Retrieving Static Web App deployment token..."
          
          # Get the deployment token for the Static Web App
          deployment_token=$(az staticwebapp secrets list \
            --name "${{ env.STATIC_WEB_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --query "properties.apiKey" \
            --output tsv)
          
          if [ -z "$deployment_token" ]; then
            echo "‚ùå Failed to retrieve deployment token"
            exit 1
          fi
          
          echo "deployment-token=$deployment_token" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployment token retrieved successfully"

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.deployment-token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: ${{ needs.validate.outputs.app-location }}
          output_location: ${{ needs.validate.outputs.output-location }}
          skip_app_build: false

      - name: Verify Deployment
        run: |
          echo "üîç Verifying deployment status..."
          
          # Get Static Web App details
          swa_details=$(az staticwebapp show \
            --name "${{ env.STATIC_WEB_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --output json)
          
          default_hostname=$(echo "$swa_details" | jq -r '.defaultHostname')
          custom_domains=$(echo "$swa_details" | jq -r '.customDomains[]?.name // empty' | tr '\n' ', ' | sed 's/,$//')
          
          echo "üåê Default URL: https://$default_hostname"
          if [ -n "$custom_domains" ]; then
            echo "üîó Custom Domains: $custom_domains"
          fi
          
          echo "‚úÖ Deployment verification completed!"

      - name: Create Deployment Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üöÄ Frontend Deployment Results
          
          **Deployment Details:**
          - üìç Static Web App: `${{ env.STATIC_WEB_APP_NAME }}`
          - üìÅ App Location: `${{ needs.validate.outputs.app-location }}`
          - üì§ Output Location: `${{ needs.validate.outputs.output-location }}`
          - üìÖ Deployment Time: `$(date -u '+%Y-%m-%d %H:%M:%S UTC')`
          - üîó Environment: `production`
          
          **Deployment Status:**
          ${{ job.status == 'success' && '‚úÖ **SUCCESS**: Frontend deployed successfully!' || '‚ùå **FAILED**: Deployment encountered errors. Check logs above.' }}
          
          EOF
          
          if [ "${{ job.status }}" == "success" ]; then
            # Get deployment URLs
            swa_details=$(az staticwebapp show \
              --name "${{ env.STATIC_WEB_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
              --output json 2>/dev/null || echo '{}')
            
            default_hostname=$(echo "$swa_details" | jq -r '.defaultHostname // "N/A"')
            
            cat >> $GITHUB_STEP_SUMMARY << EOF
          **üåê Access Your Website:**
          - Default URL: [https://$default_hostname](https://$default_hostname)
          
          **Next Steps:**
          - üåê Test the deployed website functionality
          - üîß Verify custom domain configuration (if applicable)
          - üìä Monitor application performance and logs
          - üîÑ Set up monitoring alerts for production usage
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          **Next Steps:**
          - üìã Review deployment logs for error details
          - üîß Fix any configuration or code issues
          - üîÑ Re-run the workflow after fixes
          - üÜò Check Azure Static Web Apps documentation for troubleshooting
          EOF
          fi

  preview:
    name: Deploy Preview (PR Only)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Get Static Web App Deployment Token
        id: swa-token
        run: |
          echo "üîë Retrieving Static Web App deployment token for preview..."
          
          deployment_token=$(az staticwebapp secrets list \
            --name "${{ env.STATIC_WEB_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --query "properties.apiKey" \
            --output tsv)
          
          echo "deployment-token=$deployment_token" >> $GITHUB_OUTPUT
          echo "‚úÖ Deployment token retrieved for preview"

      - name: Deploy Preview to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.deployment-token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: ${{ needs.validate.outputs.app-location }}
          output_location: ${{ needs.validate.outputs.output-location }}
          skip_app_build: false

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const comment = `## üîç Preview Deployment
            
            Your changes have been deployed to a preview environment!
            
            **Preview Details:**
            - üìÅ App Location: \`${{ needs.validate.outputs.app-location }}\`
            - üîó Environment: \`preview\`
            - üìÖ Deployed: \`${new Date().toISOString()}\`
            
            **üåê Preview URL:** The preview URL will be available in the Azure Static Web Apps deployment details.
            
            **Note:** Preview deployments are automatically cleaned up when the PR is closed.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
