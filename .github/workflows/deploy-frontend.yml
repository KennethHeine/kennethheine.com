name: Deploy Frontend

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['static-web-app/**', '!static-web-app/README.md']
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]
    paths: ['static-web-app/**', '!static-web-app/README.md', '.github/workflows/deploy-frontend.yml']

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  STATIC_WEB_APP_NAME: "swa-kennethheine-com-dkwcwwqm6kfxy"
  RESOURCE_GROUP_NAME: "rg-kennethheine-prod"

jobs:
  validate:
    name: Validate Frontend Code
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    outputs:
      app-location: ${{ steps.config.outputs.app-location }}
      output-location: ${{ steps.config.outputs.output-location }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: 'static-web-app/package.json'

      - name: Validate Frontend Structure
        run: |
          echo "ðŸ” Validating frontend project structure..."
          # Check required files for Next.js project
          required_files=(
            "static-web-app/package.json"
            "static-web-app/next.config.mjs"
            "static-web-app/staticwebapp.config.json"
            "static-web-app/app/layout.tsx"
            "static-web-app/app/page.tsx"
          )
          
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Required file missing: $file"
              exit 1
            else
              echo "âœ… Found: $file"
            fi
          done
          
          echo "ðŸ“ Frontend structure validation completed successfully!"

      - name: Install Dependencies
        working-directory: static-web-app
        run: |
          echo "ðŸ“¦ Installing frontend dependencies..."
          npm ci
          echo "âœ… Dependencies installed successfully!"

      - name: Build Next.js Application
        working-directory: static-web-app
        run: |
          echo "ðŸ—ï¸ Building Next.js application for static export..."
          npm run build
          echo "âœ… Next.js build completed successfully!"

      - name: Lint and Validate Code
        working-directory: static-web-app
        run: |
          echo "ðŸ” Running code validation..."
          # Validate Next.js build output
          echo "ðŸ“„ Validating Next.js build output..."
          if [ ! -d "out" ]; then
            echo "âŒ Build output directory 'out' not found"
            exit 1
          fi
          
          if [ ! -f "out/index.html" ]; then
            echo "âŒ Main index.html not found in build output"
            exit 1
          fi
          
          echo "âœ… Next.js build output validated successfully"
          
          # Check for common issues
          echo "ðŸ” Checking for common issues..."
          if grep -r "localhost" src/ --exclude-dir=node_modules 2>/dev/null; then
            echo "âš ï¸ Warning: Found localhost references in code"
          fi
          
          echo "âœ… Code validation completed!"

      - name: Extract Configuration
        id: config
        run: |
          echo "ðŸ“‹ Extracting deployment configuration..."
          
          # Get app location from parameters file
          app_location=$(grep "appLocation" infra/parameters/production.bicepparam | cut -d"'" -f2)
          output_location=$(grep "outputLocation" infra/parameters/production.bicepparam | cut -d"'" -f2)
          
          echo "app-location=$app_location" >> $GITHUB_OUTPUT
          echo "output-location=$output_location" >> $GITHUB_OUTPUT
          
          echo "ðŸ“ App Location: $app_location"
          echo "ðŸ“¤ Output Location: $output_location"

  deploy:
    name: Deploy to Azure Static Web Apps
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Azure Authentication
        run: |
          echo "ðŸ” Verifying Azure CLI setup..."
          az version
          az account show
          echo "âœ… Authentication verified"

      - name: Get Static Web App Deployment Token
        id: swa-token
        run: |
          echo "ðŸ”‘ Retrieving Static Web App deployment token..."
          
          # Get the deployment token for the Static Web App
          deployment_token=$(az staticwebapp secrets list \
            --name "${{ env.STATIC_WEB_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --query "properties.apiKey" \
            --output tsv)
          
          if [ -z "$deployment_token" ]; then
            echo "âŒ Failed to retrieve deployment token"
            exit 1
          fi
          echo "deployment-token=$deployment_token" >> $GITHUB_OUTPUT
          echo "âœ… Deployment token retrieved successfully"

      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.deployment-token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: ${{ needs.validate.outputs.app-location }}
          output_location: ${{ needs.validate.outputs.output-location }}

      - name: Verify Deployment
        run: |
          echo "ðŸ” Verifying deployment status..."
          
          # Get Static Web App details
          swa_details=$(az staticwebapp show \
            --name "${{ env.STATIC_WEB_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --output json)
          
          default_hostname=$(echo "$swa_details" | jq -r '.defaultHostname')
          custom_domains=$(echo "$swa_details" | jq -r '.customDomains[]?.name // empty' | tr '\n' ', ' | sed 's/,$//')
          
          echo "ðŸŒ Default URL: https://$default_hostname"
          if [ -n "$custom_domains" ]; then
            echo "ðŸ”— Custom Domains: $custom_domains"
          fi
          
          echo "âœ… Deployment verification completed!"

      - name: Create Deployment Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Frontend Deployment Results
          
          **Deployment Details:**
          - ðŸ“ Static Web App: `${{ env.STATIC_WEB_APP_NAME }}`
          - ðŸ“ App Location: `${{ needs.validate.outputs.app-location }}`
          - ðŸ“¤ Output Location: `${{ needs.validate.outputs.output-location }}`
          - ðŸ“… Deployment Time: `$(date -u '+%Y-%m-%d %H:%M:%S UTC')`
          - ðŸ”— Environment: `production`
          
          **Deployment Status:**
          ${{ job.status == 'success' && 'âœ… **SUCCESS**: Frontend deployed successfully!' || 'âŒ **FAILED**: Deployment encountered errors. Check logs above.' }}
          
          EOF
          
          if [ "${{ job.status }}" == "success" ]; then
            # Get deployment URLs
            swa_details=$(az staticwebapp show \
              --name "${{ env.STATIC_WEB_APP_NAME }}" \
              --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
              --output json 2>/dev/null || echo '{}')
            
            default_hostname=$(echo "$swa_details" | jq -r '.defaultHostname // "N/A"')
            
            cat >> $GITHUB_STEP_SUMMARY << EOF
          **ðŸŒ Access Your Website:**
          - Default URL: [https://$default_hostname](https://$default_hostname)
          
          **Next Steps:**
          - ðŸŒ Test the deployed website functionality
          - ðŸ”§ Verify custom domain configuration (if applicable)
          - ðŸ“Š Monitor application performance and logs
          - ðŸ”„ Set up monitoring alerts for production usage
          EOF
          else
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          **Next Steps:**
          - ðŸ“‹ Review deployment logs for error details
          - ðŸ”§ Fix any configuration or code issues
          - ðŸ”„ Re-run the workflow after fixes
          - ðŸ†˜ Check Azure Static Web Apps documentation for troubleshooting
          EOF
          fi
  preview:
    name: Deploy Preview (PR Only)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request' && github.event.action != 'closed'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Get Static Web App Deployment Token
        id: swa-token
        run: |
          echo "ðŸ”‘ Retrieving Static Web App deployment token for preview..."
          
          deployment_token=$(az staticwebapp secrets list \
            --name "${{ env.STATIC_WEB_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --query "properties.apiKey" \
            --output tsv)
          echo "deployment-token=$deployment_token" >> $GITHUB_OUTPUT
          echo "âœ… Deployment token retrieved for preview"

      - name: Deploy Preview to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.deployment-token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "upload"
          app_location: ${{ needs.validate.outputs.app-location }}
          output_location: ${{ needs.validate.outputs.output-location }}

      - name: Comment PR with Preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const comment = `## ðŸ” Preview Deployment
            
            Your changes have been deployed to a preview environment!
            
            **Preview Details:**
            - ðŸ“ App Location: \`${{ needs.validate.outputs.app-location }}\`
            - ðŸ”— Environment: \`preview\`
            - ðŸ“… Deployed: \`${new Date().toISOString()}\`
            
            **ðŸŒ Preview URL:** The preview URL will be available in the Azure Static Web Apps deployment details.
              **Note:** Preview deployments are automatically cleaned up when the PR is closed.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
  cleanup-preview:
    name: Cleanup Preview Environment
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Azure Login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Get Static Web App Deployment Token
        id: swa-token
        run: |
          echo "ðŸ”‘ Retrieving Static Web App deployment token for cleanup..."
            deployment_token=$(az staticwebapp secrets list \
            --name "${{ env.STATIC_WEB_APP_NAME }}" \
            --resource-group "${{ env.RESOURCE_GROUP_NAME }}" \
            --query "properties.apiKey" \
            --output tsv)
          echo "deployment-token=$deployment_token" >> $GITHUB_OUTPUT
          echo "âœ… Deployment token retrieved for cleanup"

      - name: Cleanup Preview Environment
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa-token.outputs.deployment-token }}
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          action: "close"
          app_location: "/"
          skip_app_build: true

      - name: Comment PR with Cleanup Confirmation
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ðŸ§¹ Preview Environment Cleaned Up
            
            The preview environment for this pull request has been successfully removed.
            
            **Cleanup Details:**
            - ðŸ—‘ï¸ Preview environment deleted
            - ðŸ“… Cleaned up: \`${new Date().toISOString()}\`
            - ðŸ”— Status: \`${{ github.event.action == 'closed' && github.event.pull_request.merged && 'Merged and cleaned up' || 'Closed and cleaned up' }}\`
            
            Thank you for your contribution! ðŸŽ‰`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Create Cleanup Summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ§¹ Preview Environment Cleanup
          
          **Cleanup Status:** âœ… **SUCCESS** - Preview environment removed successfully!
          
          **Details:**
          - ðŸ”— Pull Request: `#${{ github.event.number }}`
          - ðŸ“ Static Web App: `${{ env.STATIC_WEB_APP_NAME }}`
          - ðŸ—‘ï¸ Action: `Preview environment cleanup`
          - ðŸ“… Cleanup Time: `$(date -u '+%Y-%m-%d %H:%M:%S UTC')`
          - ðŸ”„ Trigger: `${{ github.event.action == 'closed' && github.event.pull_request.merged && 'PR merged' || 'PR closed' }}`
          
          **Environment Status:**
          - ðŸŒ Preview URL: `Deactivated and removed`
          - ðŸ’¾ Resources: `Cleaned up automatically`
          - ðŸ”’ Security: `No dangling resources or access`
          
          **Next Steps:**
          - ðŸŽ¯ Preview environment has been completely removed
          - ðŸ” No manual cleanup required
          - ðŸ“Š Monitor main deployment for production updates
          EOF
